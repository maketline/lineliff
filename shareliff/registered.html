
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LIFF Share Flex</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
      integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
      crossorigin="anonymous"
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
      crossorigin="anonymous"
    />
    <style></style>
  </head>

  <body class="bg-dark">
    <div id="divGuess" class="container-fluid mt-5">
      <div class="row justify-content-center">
        <div class="col text-center ">
          <h3 class="text-primary fw-bolder">ส่งข้อความด้วย LIFF</h3>
        </div>
      </div>
      <div class="row justify-content-center">
        <div class="col-md-6 text-center">
          <!-- <input
            type="text"
            id="flex"
            value=""
            placeholder="ใส่ข้อความ หรือ Flex message"
            class="form-control"
          /> -->
          <textarea class="form-control" id="flex" name = "flex" rows="7"></textarea>
        </div>
      </div>
      <div class="row justify-content-center mt-3">
        <div class="col-md-6 text-center">
          <input
            type="button"
            id="button"
            value="ส่งเลย"
            onclick="process()"
            class="btn btn-warning"
          />
        </div>
      </div>
    </div>

    <script
      charset="utf-8"
      src="https://static.line-scdn.net/liff/edge/2/sdk.js"
    ></script>

    <script>
      function process() {
        let input = document.getElementById("flex").value;
        let output;
        let isFlex = false;
        try {
          let flex = JSON.parse(input);
          output = flex;
          isFlex = true;
        } catch (e) {
          output = input;
          isFlex = false;
        }
        sendTemplatFlex(output, isFlex);
      }
    </script>
    <script>
      (async () => {
        let liffId = "1656079273-1Z8LWAWR";
        await liff.init({ liffId: liffId });

        liff.ready.then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          }
        });
      })();

      function setCredit(message) {
        if (message.footer?.contents?.length > 0) {
          let length = message.footer?.contents.length;
          if (message.footer?.contents[length - 1]?.type == "spacer") {
            message.footer.contents.push("xx");
            length++
            message.footer.contents[length - 1] =
              message.footer.contents[length - 2];
            message.footer.contents[length - 2] = {
              type: "text",
              text: "Developed by Teerapong",
              weight: "bold",
              align: "center",
              decoration: "underline",
              color: "#ff0000"
            };
          } else {
            message.footer?.contents.push({
              type: "text",
              text: "Developed by Teerapong",
              weight: "bold",
              align: "center",
              decoration: "underline",
              color: "#ff0000",
              adjustMode: "shrink-to-fit"
            });
          }
        } else {
          message.footer = {
            type: "box",
            layout: "vertical",
            spacing: "sm",
            contents: [
              {
                type: "text",
                text: "Developed by teerapong",
                weight: "bold",
                align: "center",
                decoration: "underline",
                color: "#ff0000",
                adjustMode: "shrink-to-fit"
              }
            ],
            flex: 0
          };
        }
        return message;
      }

      async function sendTemplatFlex(output, isFlex) {
        method = "share";
        let message;
        if (isFlex) {
          if (output.type != "flex") {
            message = {
              type: "flex",
              altText: "flex",
              contents: output
            };
            if (message.contents.type == "carousel") {
              message.contents.contents.map(bubble => setCredit(bubble));
            } else {
              message.contents = setCredit(message.contents);
            }
          } else {
            message = `${output}\n\nDeveloped by Teerapong`;
          }
        } else {
          message = {
            type: "text",
            text: `${output}\n\nDeveloped by Teerapong`
          };
        }
        console.log(message);
        liff.ready.then(() => {
          if (!liff.isInClient()) {
            if (!liff.isLoggedIn()) {
              liff.login();
            } else {
              if (liff.isApiAvailable("shareTargetPicker")) {
                liff.shareTargetPicker([message]).then(result => {
                  if (result) {
                    // ผู้ใช้งานได้กดแชร์ข้อความ แต่จะสำเร็จหรือไม่ให้ดูที่ ${result.status}
                    alert(`${result.status} ส่งข้อความแล้ว!`);
                    liff.closeWindow();
                  } else {
                    // ผู้ใช้งานกดปิดหน้า ShareTargetPicker หรือใช้แอป LINE เวอร์ชันต่ำกว่า 10.10.1

                    // ใช้ liff.getLineVersion() เพื่อดึงเลขเวอร์ชันจากแอป LINE ของผู้ใช้
                    const [majorVer, minorVer, patchVer] = (
                      liff.getLineVersion() || ""
                    ).split(".");

                    // alert ในกรณที่ใช้งาน LIFF ใน external browser ค่า minorVer จะเป็น undefined
                    if (minorVer === undefined) {
                      alert("ยกเลิกการส่งข้อความในบราวเซอร์");
                      return;
                    }

                    // alert ในกรณีที่ผู้ใช้งานใช้แอป LINE v10.10.1 หรือเวอร์ชันใหม่กว่า
                    if (
                      parseInt(majorVer) >= 10 &&
                      parseInt(minorVer) >= 10 &&
                      parseInt(patchVer) > 0
                    ) {
                      alert("ยกเลิกการส่งข้อความในไลน์");
                    }
                  }
                });
              }
            }
          } else {
            if (liff.isApiAvailable("shareTargetPicker")) {
              liff.shareTargetPicker([message]).then(result => {
                if (result) {
                  // ผู้ใช้งานได้กดแชร์ข้อความ แต่จะสำเร็จหรือไม่ให้ดูที่ ${result.status}
                  alert(`${result.status} ส่งข้อความแล้ว!`);
                  liff.closeWindow();
                } else {
                  // ผู้ใช้งานกดปิดหน้า ShareTargetPicker หรือใช้แอป LINE เวอร์ชันต่ำกว่า 10.10.1

                  // ใช้ liff.getLineVersion() เพื่อดึงเลขเวอร์ชันจากแอป LINE ของผู้ใช้
                  const [majorVer, minorVer, patchVer] = (
                    liff.getLineVersion() || ""
                  ).split(".");

                  // alert ในกรณที่ใช้งาน LIFF ใน external browser ค่า minorVer จะเป็น undefined
                  if (minorVer === undefined) {
                    alert("ยกเลิกการส่งข้อความในบราวเซอร์");
                    return;
                  }

                  // alert ในกรณีที่ผู้ใช้งานใช้แอป LINE v10.10.1 หรือเวอร์ชันใหม่กว่า
                  if (
                    parseInt(majorVer) >= 10 &&
                    parseInt(minorVer) >= 10 &&
                    parseInt(patchVer) > 0
                  ) {
                    alert("ยกเลิกการส่งข้อความในไลน์");
                  }
                }
              });
            }
          }
        });
      }
    </script>
  </body>
  <script></script>
</html>
